sudo: false
language: rust

cache: cargo

env:
  global:
    - RUST_BACKTRACE=1

matrix:
  include:
    - rust: 1.20.0
      env: DESCRIPTION="minimum supported Rust"
      script:
        - |
          for features in \
              "aggressive-rustc-lints" \
              "aggressive-rustc-lints extprim" \
              "aggressive-rustc-lints quickcheck" \
              "aggressive-rustc-lints extprim quickcheck"
          do
              cargo test --verbose --all --lib --features "${features}"
              cargo test --verbose --all --tests --features "${features}"
          done

    - rust: stable
      env: DESCRIPTION="stable Rust"
      script:
        - |
          for features in \
              "aggressive-rustc-lints version-sync" \
              "aggressive-rustc-lints extprim version-sync" \
              "aggressive-rustc-lints quickcheck version-sync" \
              "aggressive-rustc-lints extprim quickcheck version-sync"
          do
              cargo test --verbose --all --lib --features "${features}"
              cargo test --verbose --all --tests --features "${features}"
          done

    - rust: beta
      env: DESCRIPTION="beta Rust"
      script:
        - |
          for features in \
              "aggressive-rustc-lints version-sync" \
              "aggressive-rustc-lints extprim version-sync" \
              "aggressive-rustc-lints quickcheck version-sync" \
              "aggressive-rustc-lints extprim quickcheck version-sync"
          do
              cargo test --verbose --all --lib --features "${features}"
              cargo test --verbose --all --tests --features "${features}"
          done

    - rust: nightly
      env: DESCRIPTION="nightly Rust, clippy"
      install:
        - rustup component add clippy-preview
      script:
        - cargo test --verbose --all --benches --features "${FEATURES}" &&
        - cargo clippy --verbose --all --features "${FEATURES}"
        - |
          for features in \
              "aggressive-rustc-lints nightly test-nightly-regressions version-sync" \
              "aggressive-rustc-lints extprim nightly test-nightly-regressions version-sync" \
              "aggressive-rustc-lints nightly quickcheck test-nightly-regressions version-sync" \
              "aggressive-rustc-lints extprim nightly quickcheck test-nightly-regressions version-sync"
          do
              cargo test --verbose --all --lib --features "${features}"
              cargo test --verbose --all --tests --features "${features}"
              cargo test --verbose --all --benches --features "${features}"
              cargo clippy --verbose --all --features "${features}"
          done

    # Host documentation on <https://hcpl.github.com/serde_mtproto>
    - rust: nightly
      env: DOC_UPLOAD  # Just a marker visible from Travis logs
      install:
        - cargo install cargo-update || echo "cargo-update already installed"
        - cargo install cargo-travis || echo "cargo-travis already installed"
        - cargo install-update cargo-travis
      script:
        - cargo doc --manifest-path Cargo.toml --features "extprim quickcheck"
        - cargo doc --manifest-path serde_mtproto_derive/Cargo.toml
        - git clone --depth=1 --branch gh-pages "https://github.com/${TRAVIS_REPO_SLUG}" target/gh-pages
        - |
          if [ -e "target/gh-pages/${TRAVIS_BRANCH}/index.html" ]; then
              rm -f target/doc/index.html
          else
              echo '<!DOCTYPE html>' > target/doc/index.html
              echo '<meta http-equiv="refresh" content="0; url=serde_mtproto/">' >> target/doc/index.html
              echo '<a href="serde_mtproto/">Redirect</a>' >> target/doc/index.html
          fi
        - rm -rf target/gh-pages
      after_success:
        - cargo doc-upload --message $'Automatic Travis documentation build\n\n'"${TRAVIS_COMMIT_MESSAGE}"

after_success:
  - |
    # Run benchmarks against master and PR branch
    # Adapted from <https://beachape.com/blog/2016/11/02/rust-performance-testing-on-travis-ci/>
    if [ "${TRAVIS_PULL_REQUEST}" = true ] && [ "${TRAVIS_RUST_VERSION}" = nightly ]; then
        cd "${TRAVIS_BUILD_DIR}"/.. &&
        git clone "${REMOTE_URL}" "${TRAVIS_REPO_SLUG}-bench" &&
        cd "${TRAVIS_REPO_SLUG}-bench" &&
        # Bench master
        git checkout master &&
        cargo bench > before &&
        # Bench PR'ing branch
        git checkout "${TRAVIS_COMMIT}" &&
        cargo bench > after &&
        # Compare results
        cargo install --force cargo-benchcmp &&
        cargo benchcmp --include-missing before after
    fi
